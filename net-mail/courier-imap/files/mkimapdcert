#! /bin/sh
#
# Copyright 2000 Double Precision, Inc.  See COPYING for
# distribution information.
#
# This is a short script to quickly generate a self-signed X.509 key for
# IMAP over SSL.  Normally this script would get called by an automatic
# package installation routine.

test -x /usr/bin/openssl || exit 0

prefix="/usr"
pemfile="/etc/courier-imap/imapd.pem"

if test -f $pemfile
then
	echo "$pemfile already exists."
	exit 1
fi

cp /dev/null $pemfile
chmod 600 $pemfile
chown root $pemfile

cleanup() {
	rm -f $pemfile
	exit 1
}

/usr/bin/openssl req -new -x509 -days 365 -nodes \
	-config /etc/courier-imap/imapd.cnf -out $pemfile -keyout $pemfile || cleanup
/usr/bin/openssl x509 -subject -dates -fingerprint -noout -in $pemfile || cleanup
